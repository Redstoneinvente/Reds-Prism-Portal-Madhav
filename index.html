
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prism | Project Portal</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --hue: 250;
            --primary: hsl(var(--hue), 40%, 40%);
            --on-primary: #ffffff;
            --primary-container: hsl(var(--hue), 50%, 90%);
            --on-primary-container: hsl(var(--hue), 60%, 15%);
            --surface: hsl(var(--hue), 10%, 98%);
            --surface-variant: hsl(var(--hue), 20%, 94%);
            --outline: hsl(var(--hue), 10%, 80%);
            --shadow: rgba(var(--hue), 20%, 10%, 0.1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Color coding for status labels */
.status-pill {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
}

#ai_health_box {
    margin-top: 16px;    /* Space above the card */
    margin-bottom: 24px; /* Larger space below to separate from the next section */
    width: 100%;         /* Ensure it spans the full width of the container */
    display: block;      /* Ensures margins are respected */
}

/* Optional: Add spacing between the Health Card and Analysis Card if they are siblings */
#ai_health_box + #ai_analysis_box {
    margin-top: 8px;
}

.status-planning { background: #E1F5FE; color: #01579B; }
.status-prototyping { background: #F3E5F5; color: #4A148C; }
.status-active { background: #E8F5E9; color: #1B5E20; }
.status-polish { background: #FFFDE7; color: #F57F17; }
.status-testing { background: #FFEBEE; color: #B71C1C; }
.status-hold { background: #ECEFF1; color: #263238; }

.fade-in {
    animation: fadeIn 0.8s ease-out;
}

/* Mobile Optimization for AI Card */
@media (max-width: 600px) {
    .ai-analysis-card {
        padding: 16px !important; /* Slightly tighter padding */
        border-radius: 24px !important; /* Slightly less rounded for small screens */
    }
    
    .ai-verdict-title {
        font-size: 1.15rem !important; /* Scale down the title */
    }

    .m3-pay-btn {
        padding: 12px 16px !important;
        font-size: 0.8rem !important;
    }
}

/* Ensure the container itself doesn't overflow */
#ai_analysis_box {
    width: 100%;
    box-sizing: border-box;
}

/* M3 Spinner for the Loading State */
.m3-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid var(--primary);
    border-bottom-color: transparent;
    border-radius: 50%;
    animation: rotate 0.8s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* PayPal/M3 Primary Button */
.m3-pay-btn {
    width: 100%;
    border: none;
    padding: 14px 24px;
    border-radius: 100px; /* M3 Pill Shape */
    background: #0070ba; /* PayPal Blue */
    color: white;
    font-weight: 700;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.m3-pay-btn:hover {
    background: #005ea6;
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 112, 186, 0.3);
}

/* Animations */
.fade-in {
    animation: m3Fade 0.6s ease-out;
}

@keyframes m3Fade {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Material 3 Spinner Animation */
.m3-spinner {
    width: 18px;
    height: 18px;
    border: 2px solid var(--primary);
    border-bottom-color: transparent;
    border-radius: 50%;
    display: inline-block;
    animation: m3rotate 0.8s linear infinite;
}

@keyframes m3rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Smooth Result Transition */
.m3-result-card {
    background: var(--primary-container);
    color: var(--on-primary-container);
    padding: 24px;
    border-radius: 28px; /* High rounding for M3 */
    border: 1px solid var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    animation: m3Appear 0.5s cubic-bezier(0, 0, 0.2, 1);
}

@keyframes m3Appear {
    from { opacity: 0; scale: 0.95; }
    to { opacity: 1; scale: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.badge-requested {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 4px;
    border: 1px solid #c8e6c9;
    animation: fadeIn 0.3s ease;
}

        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 20px; background-color: var(--surface); color: #1c1b1f; 
            font-family: 'Google Sans', 'Roboto', sans-serif; display: flex; justify-content: center;
        }

        @media print {
    .print-only {
        display: block !important;
    }
}

.loading-shimmer {
    font-size: 0.8rem;
    font-weight: bold;
    color: var(--primary);
    animation: pulse 1.5s infinite;
    padding: 15px;
    text-align: center;
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
}

@keyframes pulse {
    0% { opacity: 0.4; }
    50% { opacity: 1; }
    100% { opacity: 0.4; }
}

@media print {
    /* Hide all UI elements that shouldn't be on a static document */
    .no-print, .btn, #adminHeader, #shareSection, #adminFeatureAdd, #adminAddonControl, .modal-overlay {
        display: none !important;
    }

    body {
        background: white !important;
        padding: 0;
    }

    .container {
        max-width: 100%;
        width: 100%;
    }

    .card {
        border: 1px solid #eee !important;
        break-inside: avoid;
        box-shadow: none !important;
    }

    /* Force background colors to show in PDF */
    header {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        background-color: var(--primary-container) !important;
    }

    .progress-fill {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

        .spinner {
    width: 48px;
    height: 48px;
    border: 5px solid var(--primary-container);
    border-bottom-color: var(--primary);
    border-radius: 50%;
    display: inline-block;
    animation: rotation 1s linear infinite;
}

@keyframes rotation {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Ensure views are hidden by default to prevent flickering */
#dashboardView, #ticketView, #creatorView, #loginView {
    display: none;
}

/* Show them only when the .hidden class is NOT present */
#dashboardView:not(.hidden), 
#ticketView:not(.hidden), 
#creatorView:not(.hidden), 
#loginView:not(.hidden) {
    display: block;
}

        @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(76, 175, 80, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.btn-sm {
    padding: 8px 16px;
    font-size: 0.85rem;
    height: 36px;
}

        .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
}
.modal-card {
    background: var(--surface); width: 90%; max-width: 400px;
    padding: 24px; border-radius: 28px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .container { width: 100%; max-width: 850px; animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--surface-variant); border-radius: 28px; padding: 24px; margin-bottom: 16px; 
            border: 1px solid transparent; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { box-shadow: 0 4px 12px var(--shadow); }

        header {
            background: var(--primary-container); color: var(--on-primary-container);
            padding: 40px 24px; border-radius: 32px; text-align: center; margin-bottom: 24px;
            position: relative; overflow: hidden;
        }

        .field-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 8px; color: var(--primary); margin-left: 4px; }
        
        input, textarea, select {
            width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--outline);
            background: #ffffff; font-size: 1rem; transition: border 0.3s, background 0.3s;
        }
        input:focus { outline: none; border: 2px solid var(--primary); background: #fff; }
        input:disabled, textarea:disabled, select:disabled {
            background: transparent; border: 1px solid transparent; padding-left: 4px; color: #1c1b1f; font-weight: 500; appearance: none;
        }

        .btn {
            padding: 12px 24px; border-radius: 100px; border: none; cursor: pointer;
            font-weight: 500; display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s; font-family: 'Google Sans', sans-serif;
        }
        .btn-filled { background: var(--primary); color: var(--on-primary); }
        .btn-filled:hover { opacity: 0.9; transform: scale(1.02); box-shadow: 0 2px 8px var(--shadow); }
        .btn-tonal { background: var(--primary-container); color: var(--on-primary-container); }
        .btn-outline { background: transparent; border: 1px solid var(--outline); color: var(--primary); }

        .progress-track { background: rgba(0,0,0,0.08); height: 8px; border-radius: 10px; margin: 16px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 10px; transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }

        .feature-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            background: white; border-radius: 16px; margin-bottom: 8px; border: 1px solid rgba(0,0,0,0.03);
        }
        .feature-item.done { opacity: 0.6; }
        .feature-item.done span { text-decoration: line-through; }

        .history-entry { 
            font-size: 0.8rem; padding: 10px 12px; border-left: 3px solid var(--primary); 
            background: white; margin-bottom: 8px; border-radius: 4px 16px 16px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        #historyList { max-height: 300px; overflow-y: auto; padding-right: 8px; }
        .admin-only { border: 2px dashed var(--primary); background: rgba(255,255,255,0.6); }
        
        .badge-admin { 
    background: var(--primary); 
    color: white; 
    padding: 4px 10px; /* Reduced from 12px */
    border-radius: 8px; /* Slightly less rounded for a tighter look */
    font-size: 10px; /* Force a smaller, consistent size */
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: fit-content; /* Ensures it doesn't stretch to full width */
}

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loadingView" class="modal-overlay" style="background: var(--surface); z-index: 2000;">
    <div style="text-align: center;">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-weight: 500; color: var(--primary); letter-spacing: 1px;">SYNCING PRISM...</p>
    </div>
</div>

<div class="container">
    <div id="loginView" class="hidden">
    <div class="card" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <h2>Admin Access</h2>
        <div class="field-group">
            <label>Email</label>
            <input type="email" id="auth_email">
        </div>
        <div class="field-group">
            <label>Password</label>
            <input type="password" id="auth_pass">
        </div>
        <button class="btn btn-filled" style="width: 100%; justify-content: center;" onclick="handleLogin()">Login to Prism</button>
        <p id="loginError" style="color: red; font-size: 0.8rem; margin-top: 10px;"></p>
    </div>
</div>

<div id="adminHeader" class="hidden" style="background: white; border-radius: 20px; padding: 12px 20px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px var(--shadow); border: 1px solid var(--outline);">
    
    <div style="display: flex; align-items: center; gap: 12px;">
        <button class="btn btn-tonal btn-sm" onclick="goHome()" style="padding: 8px 16px;">
            <span class="material-symbols-outlined" style="font-size: 18px;">dashboard</span>
            Dashboard
        </button>
        <div style="height: 24px; width: 1px; background: var(--outline); margin: 0 8px;"></div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; animation: pulse 2s infinite;"></div>
            <span id="adminEmailDisplay" style="font-size: 0.85rem; font-weight: 500; opacity: 0.7;">Admin Mode</span>
        </div>
    </div>

    <div style="display: flex; gap: 12px; align-items: center;">
        <button class="btn btn-outline btn-sm" onclick="handleLogout()" style="border-color: #ffbaba; color: #d32f2f;">
            <span class="material-symbols-outlined" style="font-size: 18px;">logout</span>
            Sign Out
        </button>
        <button class="btn btn-filled btn-sm" onclick="saveToDisk()" style="box-shadow: 0 4px 10px rgba(var(--hue), 40%, 40%, 0.3);">
            <span class="material-symbols-outlined" style="font-size: 18px;">cloud_upload</span>
            Push Changes
        </button>
    </div>
</div>

    <div id="dashboardView">
        <h1 style="font-size: 2.5rem; letter-spacing: -1px;">Prism <span style="font-weight: 400; opacity: 0.5;">Portal</span></h1>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
            <p style="opacity: 0.7;">Welcome back, Developer.</p>
            <button class="btn btn-filled" onclick="showCreator()">
                <span class="material-symbols-outlined">add</span> Create Ticket
            </button>
        </div>
        
        <div style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;">
            <div style="position: relative; display: flex; align-items: center;">
                <span class="material-symbols-outlined" style="position: absolute; left: 12px; opacity: 0.5;">search</span>
                <input type="text" id="dashboardSearch" placeholder="Search..." oninput="renderDashboard()" 
                    style="padding-left: 40px; height: 48px; border-radius: 24px; border: 1px solid var(--outline); background: var(--surface-variant); width: 100%;">
            </div>

            <div style="display: flex; gap: 8px;">
                <button id="btnListView" class="btn btn-filled btn-sm" onclick="setDashboardView('list')">
                    <span class="material-symbols-outlined" style="font-size: 18px;">format_list_bulleted</span> List View
                </button>
                <button id="btnGroupView" class="btn btn-tonal btn-sm" onclick="setDashboardView('client')">
                    <span class="material-symbols-outlined" style="font-size: 18px;">group</span> Group by Client
                </button>
            </div>
        </div>

        <div id="projectList"></div>

    </div>

    <div id="creatorView" class="hidden">
        <button class="btn btn-outline" style="margin-bottom: 24px;" onclick="goHome()">
            <span class="material-symbols-outlined">arrow_back</span> Back
        </button>
        <div class="card" style="background: white;">
            <h2 style="margin-top:0">New Project Details</h2>
            <div class="field-group">
                <label>Project Name</label>
                <input type="text" id="c_name" placeholder="e.g. Procedural Dungeon Generator" oninput="updateTheme(this.value)">
            </div>
            <div class="field-group">
                <label>Client Name</label>
                <input type="text" id="c_client" placeholder="Company or Individual">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="field-group">
                    <label>Budget ($)</label>
                    <input type="number" id="c_price" value="1200">
                </div>
                <div class="field-group">
                    <label>Delivery Date</label>
                    <input type="date" id="c_end">
                </div>
            </div>
            <button class="btn btn-filled" style="width:100%; justify-content: center; padding: 18px;" onclick="createProject()">
                Generate Project Ticket
            </button>
        </div>
    </div>

    <div id="ticketView" class="hidden">
        <div id="adminHeader" class="hidden" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <button class="btn btn-outline btn-sm" onclick="goHome()">Dashboard</button>
            <div class="badge-admin">ADMIN EDITOR</div>
            <button class="btn btn-filled btn-sm" onclick="saveToDisk()">Save Changes</button>
        </div>

        <header id="mainHeader">
            <input type="text" id="t_name" style="font-size: 2rem; text-align:center; font-weight:700; background:transparent; border:none; color:inherit;" disabled onchange="markDirty('Updated Name')">
            <div id="t_id" style="font-family: monospace; opacity: 0.6; margin-bottom: 15px;"></div>
            
            <div style="max-width: 200px; margin: 0 auto;">
                <select id="t_status" disabled onchange="markDirty('Changed status')">
                    <option value="Planning">üìù Planning / Discovery</option>
    <option value="Pre-Production">üèóÔ∏è Pre-Production</option>
    <option value="Prototyping">üïπÔ∏è Prototyping</option>
    <option value="In Progress">üöÄ Active Development</option>
    <option value="Polish">‚ú® Polish & UI</option>
    <option value="Testing">üêû QA / Testing</option>
    <option value="Review">üëÄ Client Review</option>
    <option value="Completed">‚úÖ Awaiting Payment</option>
    <option value="Completed">‚úÖ Project Finished</option>
    <option value="On Hold">‚è∏Ô∏è On Hold</option>
                </select>
            </div>
        </header>

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
            <div class="left-col">
                <div class="card">
                    <h3 style="margin-top:0">Project Scope</h3>
                    <textarea id="t_scope" rows="6" disabled onchange="markDirty('Modified scope text')"></textarea>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin:0">Features</h3>
                        <div id="adminFeatureAdd" class="hidden">
                            <button class="btn btn-tonal btn-sm" onclick="addFeaturePrompt()">+ Add</button>
                        </div>
                    </div>
                    <div id="featureList" style="margin-top: 16px;"></div>
                </div>
            </div>

            <div class="right-col">
                <div class="card">
                    <h3 style="margin-top:0">Timeline</h3>
                    <div class="progress-track"><div id="t_progress" class="progress-fill"></div></div>
                    <label>Deadline</label>
                    <input type="date" id="t_end" disabled onchange="markDirty('Updated deadline')">

                    <div id="ai_health_box"></div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0">Financials</h3>
                    <label>Base Price</label>
                    <div style="display:flex; align-items:center; gap:4px; font-size:1.5rem; font-weight:700;">
                        $ <input type="number" id="t_price" style="font-size:1.5rem; font-weight:700; width:100%" disabled onchange="markDirty('Updated price')">
                    </div>

                    <div id="ai_analysis_box" style="margin-top: 15px;"></div>

                    <div id="ai_analysis_box" style="margin-top: 20px; width: 100%; max-width: 450px;"></div>
                </div>

                <div id="historySection" class="card">
                    <h3 style="margin-top:0">Audit Log</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        
        </div>

        <div id="featureRequestSection" class="card" style="border: 2px solid var(--primary-container);">
    <h3 style="margin-top:0">Feature Requests</h3>
    
    <div id="requestList"></div>
    
    <div id="clientRequestForm" class="hidden">
        <input type="text" id="req_name" placeholder="Feature Name" style="margin-bottom:8px">
        <textarea id="req_desc" placeholder="Describe what you need..." rows="2"></textarea>
        <button class="btn btn-filled" style="width:100%; margin-top:10px" onclick="submitRequest()">Submit Request</button>
    </div>

    <div style="margin-top: 20px; border-top: 1px solid var(--outline); padding-top: 15px;">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('requestHistory').classList.toggle('hidden')">
            <span class="material-symbols-outlined">history</span> View Request History
        </button>
        <div id="requestHistory" class="hidden" style="margin-top:15px;"></div>
    </div>
</div>

        <div class="card" style="background: var(--primary-container); color: var(--on-primary-container);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0">Client Collaboration</h3>
                <div id="adminAddonControl" class="hidden">
                    <button class="btn btn-tonal btn-sm" onclick="addAddonPrompt()" style="background:white">+ Add New Option</button>
                </div>
            </div>
            <div id="speedupList" style="margin-bottom: 20px;"></div>
            <div id="commentsList" style="margin-bottom: 20px;"></div>
            <div style="display: flex; gap: 8px; background: white; padding: 8px; border-radius: 16px;">
                <input type="text" id="newComment" placeholder="Message to developer..." style="border:none; margin:0;">
                <button class="btn btn-filled" onclick="postComment()">Send</button>
            </div>
        </div>

        <div style="text-align: right; margin-bottom: 10px;">
                <button class="btn btn-tonal btn-sm no-print" onclick="window.print()">
                    <span class="material-symbols-outlined">print</span>
                    Save as PDF / Print
                </button>
        </div>
        
        <div id="shareSection" class="card" style="text-align:center;">
            <p style="font-size: 0.9rem; margin-bottom: 12px;">Share this link with your client:</p>
            <input type="text" id="clientLink" readonly style="background: #eee; text-align: center; font-family: monospace; font-size: 0.8rem; margin-bottom: 10px;">
            <button class="btn btn-outline btn-sm" onclick="copyLink()">Copy Link</button>
        </div>

        <div class="print-only" style="display:none; text-align:center; font-size:10px; margin-top:40px; opacity:0.5;">
    Generated by Prism Portal ‚Ä¢ <span id="printDate"></span>
</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBYXOcbODnX935TjblP1dhc21uDaSJBzLs",
        authDomain: "reds-prismportal.firebaseapp.com",
        databaseURL: "https://reds-prismportal-default-rtdb.firebaseio.com",
        projectId: "reds-prismportal",
        storageBucket: "reds-prismportal.firebasestorage.app",
        messagingSenderId: "404043779432",
        appId: "1:404043779432:web:02e011e50aab507b6ddadd",
        measurementId: "G-X026E8YW3T"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let projects = [];
    let currentProj = null;
    let isAdmin = false;

   // --- AUTH STATE ---
const auth = firebase.auth();

window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const mode = urlParams.get('mode');

    // Monitor Auth State
    auth.onAuthStateChanged(user => {

        if (user) {
        isAdmin = true;
        document.getElementById('loginView').classList.add('hidden');
        
        // Update the header display
        const emailLabel = document.getElementById('adminEmailDisplay');
        if(emailLabel) emailLabel.innerText = user.email.split('@')[0]; // Shows just the username part
        
        initData(id);
    }
    
        if (user) {
            // Logged in: Grant Admin privileges
            isAdmin = true;
            document.getElementById('loginView').classList.add('hidden');
            initData(id);
        } else {
            // Not logged in
            isAdmin = false;
            if (mode === 'admin' || !id) {
                // If trying to access admin mode or dashboard, show login
                showLogin();
            } else {
                // Client view: Proceed without admin rights
                initData(id);
            }
        }
    });
};

function showLogin() {
    document.getElementById('loginView').classList.remove('hidden');
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('ticketView').classList.add('hidden');
}

async function handleLogin() {
    const email = document.getElementById('auth_email').value;
    const pass = document.getElementById('auth_pass').value;
    const errEl = document.getElementById('loginError');
    
    try {
        await auth.signInWithEmailAndPassword(email, pass);
        errEl.innerText = "";
    } catch (error) {
        errEl.innerText = "Access Denied: " + error.message;
    }
}

function handleLogout() {
    auth.signOut().then(() => goHome());
}

function hideLoading() {
    const loader = document.getElementById('loadingView');
    if (loader) loader.classList.add('hidden');
}

function initData(id) {
    db.ref("projects").on("value", (snapshot) => {
        const data = snapshot.val();
        projects = data ? Object.values(data) : [];
        
        if (id) {
            currentProj = projects.find(p => p.id === id);
            if (currentProj) {
                loadTicketUI();
            } else {
                goHome();
            }
        } else if (isAdmin) {
            renderDashboard();
        } else {
            // If we are at the root URL and not an admin, 
            // the auth listener will handle showing login.
        }

        // KEY: Hide loader once data is in!
        setTimeout(hideLoading, 500); // 500ms delay for smooth transition
    });
}

function showLogin() {
    document.getElementById('loginView').classList.remove('hidden');
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('ticketView').classList.add('hidden');
    hideLoading(); // Hide spinner so user can see login fields
}

    function goHome() { window.location.href = window.location.pathname; }

function renderDashboard() {
    const list = document.getElementById('projectList');
    if (!list) return;

    const searchTerm = document.getElementById('dashboardSearch')?.value.toLowerCase() || "";

    // 1. Filter projects first
    const filtered = projects.filter(p => 
        p.name.toLowerCase().includes(searchTerm) || 
        (p.client && p.client.toLowerCase().includes(searchTerm)) ||
        (p.status && p.status.toLowerCase().includes(searchTerm))
    );

    if (currentDashboardView === 'list') {
        renderListView(filtered, list);
    } else {
        renderGroupedView(filtered, list);
    }
}

// Standard List View
function renderListView(items, container) {
    container.innerHTML = items.map(p => renderProjectCard(p)).join('');
}

// Client Grouped View
function renderGroupedView(items, container) {
    // Group projects by client name
    const groups = items.reduce((acc, p) => {
        const clientName = p.client || "Unassigned Clients";
        if (!acc[clientName]) acc[clientName] = [];
        acc[clientName].push(p);
        return acc;
    }, {});

    container.innerHTML = Object.keys(groups).sort().map(client => `
        <div style="margin-bottom: 24px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; opacity:0.7;">
                <span class="material-symbols-outlined">person</span>
                <h3 style="margin:0; font-size:1rem; text-transform:uppercase; letter-spacing:1px;">${client}</h3>
                <div style="flex-grow:1; height:1px; background:var(--outline-variant);"></div>
                <span style="font-size:0.8rem;">${groups[client].length} Project(s)</span>
            </div>
            ${groups[client].map(p => renderProjectCard(p)).join('')}
        </div>
    `).join('');
}

// Shared Component to keep code clean
function renderProjectCard(p) {
    return `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border:1px solid var(--outline-variant);">
            <div>
                <div style="font-weight:700; font-size:1.1rem; color:hsl(${getHue(p.name)}, 50%, 30%)">${p.name}</div>
                <div style="font-size:0.85rem; opacity:0.6; display:flex; align-items:center; gap:8px; margin-top:4px;">
                    ${p.client || 'No Client'} ‚Ä¢ 
                    <span class="status-pill ${getStatusClass(p.status)}">${p.status || 'Active'}</span>
                </div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-tonal btn-sm" onclick="window.location.search='?id=${p.id}'">View</button>
                <button class="btn btn-filled btn-sm" onclick="window.location.search='?id=${p.id}&mode=admin'">Manage</button>
                <button class="btn btn-outline btn-sm" style="color:#d32f2f; border-color:#ffbaba;" onclick="deleteProject('${p.id}')">
                    <span class="material-symbols-outlined" style="font-size:18px;">delete</span>
                </button>
            </div>
        </div>
    `;
}

    function getStatusClass(status) {
    if (!status) return 'status-active';
    
    // Convert to lowercase to make the check case-insensitive
    const s = status.toLowerCase();
    
    if (s.includes('planning')) return 'status-planning';
    if (s.includes('pre-production')) return 'status-planning';
    if (s.includes('prototype')) return 'status-prototyping';
    if (s.includes('progress')) return 'status-active';
    if (s.includes('polish')) return 'status-polish';
    if (s.includes('testing')) return 'status-testing';
    if (s.includes('review')) return 'status-hold';
    if (s.includes('completed')) return 'status-active';
    if (s.includes('hold')) return 'status-hold';
    
    return 'status-active'; // Default fallback
}

    function showCreator() {
        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('creatorView').classList.remove('hidden');
        document.getElementById('c_end').valueAsDate = new Date(Date.now() + 1.21e+9);
    }

let currentDashboardView = 'list'; // 'list' or 'client'

function setDashboardView(view) {
    currentDashboardView = view;
    
    // Update button styles
    document.getElementById('btnListView').className = view === 'list' ? 'btn btn-filled btn-sm' : 'btn btn-tonal btn-sm';
    document.getElementById('btnGroupView').className = view === 'client' ? 'btn btn-filled btn-sm' : 'btn btn-tonal btn-sm';
    
    renderDashboard();
}

    function createProject() {
        const name = document.getElementById('c_name').value;
        if(!name) return;
        const newId = Math.random().toString(36).substr(2, 6).toUpperCase();
        const p = {
            id: newId, name: name, client: document.getElementById('c_client').value || "Guest",
            price: parseFloat(document.getElementById('c_price').value),
            end: document.getElementById('c_end').value,
            start: new Date().toISOString().split('T')[0],
            status: "Pending Approval", scope: "Describe deliverables...",
            features: [], history: [{t: "Project Created", d: new Date().toLocaleString()}],
            comments: [], speedups: []
        };
        db.ref("projects/" + newId).set(p).then(() => {
            window.location.search = `?id=${p.id}&mode=admin`;
        });
    }

    function loadTicketUI() {
        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('ticketView').classList.remove('hidden');

// Add this inside loadTicketUI()
document.getElementById('printDate').innerText = new Date().toLocaleDateString();

        updateTheme(currentProj.name);

        document.getElementById('t_name').value = currentProj.name;
        document.getElementById('t_id').innerText = `REFERENCE: ${currentProj.id}`;
        document.getElementById('t_status').value = currentProj.status;
        document.getElementById('t_end').value = currentProj.end;
        document.getElementById('t_scope').value = currentProj.scope;

        const displayPrice = currentProj.totalDisplayPrice || currentProj.price;
        document.getElementById('t_price').value = displayPrice;
        document.getElementById('t_price').style.color = (currentProj.totalDisplayPrice > currentProj.price) ? "#2e7d32" : "inherit";

        const shareUrl = new URL(window.location.href);
        shareUrl.searchParams.set('id', currentProj.id);
        shareUrl.searchParams.delete('mode'); 
        document.getElementById('clientLink').value = shareUrl.href;

        if (isAdmin) {
            document.getElementById('adminHeader').classList.remove('hidden');
            document.getElementById('adminFeatureAdd').classList.remove('hidden');
            document.getElementById('adminAddonControl').classList.remove('hidden');
            ['t_name', 't_status', 't_end', 't_scope', 't_price'].forEach(id => {
                const el = document.getElementById(id);
                el.disabled = false; el.classList.add('admin-only');
            });
        }

        const shareSection = document.getElementById('shareSection');
        if (isAdmin) {
            shareSection.classList.remove('hidden');
        } else {
            shareSection.classList.add('hidden');
        }

// Always show the TOTAL (Base + Active Addons) to the user
    const finalPrice = currentProj.totalDisplayPrice || currentProj.price;
    document.getElementById('t_price').value = finalPrice;

    // Visual feedback: Green if addons are active
    const priceInput = document.getElementById('t_price');
    if (currentProj.totalDisplayPrice > currentProj.price) {
        priceInput.style.color = "#2e7d32"; 
        priceInput.style.fontWeight = "bold";
    } else {
        priceInput.style.color = "inherit";
        priceInput.style.fontWeight = "700";
    }

        // Show form to client if no pending request, otherwise show status
    document.getElementById('clientRequestForm').classList.toggle('hidden', isAdmin && false);
    renderRequests();

// 1. Make sure the container exists in the HTML
    const aiBox = document.getElementById('ai_analysis_box');
    
    // 2. Call the AI Analysis
    if (aiBox) {
        renderAIAnalysis(); 
    }

renderHealthCard();
        renderFeatures();
        renderHistory();
        renderComments();
        renderSpeedups();
        updateProgress();
    }

async function submitRequest() {
    const name = document.getElementById('req_name').value;
    const desc = document.getElementById('req_desc').value;
    if(!name || !desc) return;

    if(!currentProj.requests) currentProj.requests = [];
    currentProj.requests.push({
        id: Date.now(),
        name: name,
        desc: desc,
        status: 'pending_dev', // Waiting for Dev to price it
        price: 0,
        days: 0
    });

    markDirty(`Client requested feature: ${name}`);
    saveToFirebase();
    document.getElementById('req_name').value = "";
    document.getElementById('req_desc').value = "";
}

async function devReviewRequest(reqId) {
    const req = currentProj.requests.find(r => r.id === reqId);
    
    // Use the Material You popup for price and days
    const priceStr = await showModal("Quote Price", `How much for ${req.name}?`, true, "100");
    if (priceStr === null) return; // User cancelled
    
    const daysStr = await showModal("Time Delay", "How many extra days?", true, "2");
    if (daysStr === null) return; // User cancelled

    req.price = parseFloat(priceStr) || 0;
    req.days = parseInt(daysStr) || 0;
    req.status = 'pending_client'; 
    
    markDirty(`Dev sent quote for ${req.name}: $${req.price}`);
    saveToFirebase(); // This saves the request info, but saveToFirebase() won't add it to totalDisplayPrice yet!
}

function clientAcceptRequest(reqId) {
    const req = currentProj.requests.find(r => r.id === reqId);

    // 1. Logic for Price/Date/Features
    currentProj.price = (parseFloat(currentProj.price) || 0) + parseFloat(req.price);
    if(!currentProj.features) currentProj.features = [];
    currentProj.features.push({name: req.name + " (Add-on)", done: false});

    if (req.days > 0) {
        let d = new Date(currentProj.end);
        d.setDate(d.getDate() + parseInt(req.days));
        currentProj.end = d.toISOString().split('T')[0];
    }

    // 2. NEW: Update Status instead of deleting
    req.status = 'accepted';
    req.decisionDate = new Date().toLocaleString();

    markDirty(`Approved: ${req.name}`);
    saveToFirebase();
}

async function rejectRequest(reqId) {
    const confirmed = await showModal("Decline Quote", "Archive this request?");
    if (!confirmed) return;

    const req = currentProj.requests.find(r => r.id === reqId);
    req.status = 'rejected';
    req.decisionDate = new Date().toLocaleString();

    markDirty(`Declined: ${req.name}`);
    saveToFirebase();
}

function renderRequests() {
    const activeList = document.getElementById('requestList');
    const historyList = document.getElementById('requestHistory');
    const allReqs = currentProj.requests || [];
    
    // 1. Filter into Active and History
    const active = allReqs.filter(r => !r.status || r.status === 'pending_dev' || r.status === 'pending_client');
    const history = allReqs.filter(r => r.status === 'accepted' || r.status === 'rejected');

    // 2. Render Active Requests
    if (active.length === 0) {
        activeList.innerHTML = `<p style="opacity:0.5; font-size:0.8rem;">No active requests.</p>`;
    } else {
        activeList.innerHTML = active.map(r => {
            // Check if it's waiting for your quote
            const isWaitingForDev = !r.status || r.status === 'pending_dev';
            
            return `
            <div style="background:white; padding:16px; border-radius:16px; margin-bottom:12px; border: 1px solid var(--outline);">
                <div style="font-weight:700; margin-bottom:4px;">${r.name}</div>
                <div style="font-size:0.85rem; opacity:0.7; margin-bottom:10px;">${r.desc}</div>
                
                ${isWaitingForDev ? `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="badge-admin" style="background:#5f6368; font-size:9px; padding:3px 8px;">WAITING FOR QUOTE</span>
                        ${isAdmin ? `<button class="btn btn-tonal btn-sm" onclick="devReviewRequest(${r.id})" style="height:32px;">Send Quote</button>` : ''}
                    </div>
                ` : `
                    <div style="background:var(--primary-container); padding:10px; border-radius:12px; margin-bottom:10px;">
                        <div style="font-weight:bold; color:var(--on-primary-container); font-size:0.9rem;">
                            Quote: +$${r.price} & +${r.days} days
                        </div>
                    </div>
                    ${!isAdmin ? `
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-filled btn-sm" onclick="clientAcceptRequest(${r.id})">Accept & Add</button>
                            <button class="btn btn-outline btn-sm" onclick="rejectRequest(${r.id})" style="color:#d32f2f; border-color:#ffbaba;">Decline</button>
                        </div>
                    ` : `<span style="font-size:0.8rem; opacity:0.5; font-style:italic;">Sent to client...</span>`}
                `}
            </div>`;
        }).join('');
    }

    // 3. Render History (Fixed and Persistent)
    if (history.length === 0) {
        historyList.innerHTML = `<p style="opacity:0.4; font-size:0.75rem; text-align:center; padding:10px;">No archived requests found.</p>`;
    } else {
        historyList.innerHTML = history.map(r => `
            <div style="padding:12px; border-radius:16px; background:rgba(255,255,255,0.5); margin-bottom:8px; border-left: 5px solid ${r.status === 'accepted' ? '#4CAF50' : '#F44336'};">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:600; font-size:0.85rem;">${r.name}</span>
                    <span style="font-size:0.7rem; font-weight:bold; color:${r.status === 'accepted' ? '#2E7D32' : '#C62828'}">${r.status.toUpperCase()}</span>
                </div>
                <div style="font-size:0.75rem; opacity:0.6;">$${r.price} | +${r.days} Days</div>
                <div style="font-size:0.65rem; opacity:0.4; margin-top:4px;">Date: ${r.decisionDate || 'Archived'}</div>
            </div>
        `).join('');
    }
}

// Helper to keep code clean
function renderSingleRequest(r) {
    return `
        <div style="background:white; padding:16px; border-radius:16px; margin-bottom:12px; border: 1px solid var(--outline);">
            <div style="font-weight:700;">${r.name}</div>
            <div style="font-size:0.85rem; opacity:0.7; margin-bottom:10px;">${r.desc}</div>
            ${r.status === 'pending_dev' ? `
                <div style="display:flex; justify-content:space-between;">
                    <span class="badge-admin" style="background:#666">WAITING FOR QUOTE</span>
                    ${isAdmin ? `<button class="btn btn-tonal btn-sm" onclick="devReviewRequest(${r.id})">Quote</button>` : ''}
                </div>
            ` : `
                <div style="background:var(--primary-container); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <div style="font-weight:bold;">Quote: +$${r.price} & +${r.days} days</div>
                </div>
                ${!isAdmin ? `
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-filled btn-sm" onclick="clientAcceptRequest(${r.id})">Accept</button>
                        <button class="btn btn-outline btn-sm" onclick="rejectRequest(${r.id})" style="color:red; border-color:red;">Decline</button>
                    </div>
                ` : `<span style="font-size:0.8rem; opacity:0.5;">Waiting for client...</span>`}
            `}
        </div>
    `;
}

   function saveToFirebase() {
    if (!currentProj) return;
    
    if (isAdmin) {
        currentProj.name = document.getElementById('t_name').value;
        currentProj.status = document.getElementById('t_status').value;
        currentProj.end = document.getElementById('t_end').value;
        currentProj.scope = document.getElementById('t_scope').value;
        
        /* FIX: When you manually edit the price field as Admin, 
           we save it as the NEW Base Price. 
           We use totalDisplayPrice here to subtract addons 
           so the Base Price stays "pure".
        */
        let inputVal = parseFloat(document.getElementById('t_price').value) || 0;
        let addonsTotal = (currentProj.speedups || [])
            .filter(s => s.active)
            .reduce((sum, s) => sum + s.price, 0);
            
        // If the admin is editing, we assume they are editing the TOTAL. 
        // We calculate the new base by subtracting active addons.
        currentProj.price = inputVal - addonsTotal;
    }

    // Recalculate the Total for display
    let basePrice = parseFloat(currentProj.price) || 0;
    let currentAddons = (currentProj.speedups || [])
        .filter(s => s.active)
        .reduce((sum, s) => sum + s.price, 0);

    currentProj.totalDisplayPrice = basePrice + currentAddons;
renderAIAnalysis();
renderHealthCard();
    db.ref("projects/" + currentProj.id).update(currentProj);
}

    function saveToDisk() { saveToFirebase(); alert("Synced to Cloud."); }

    async function addFeaturePrompt() {
    const f = await showModal("Add Feature", "Enter the name of the new deliverable:", true);
    
    // If the user cancels or leaves it empty, do nothing
    if(!f || f.trim() === "") return;

    if(!currentProj.features) currentProj.features = [];
    currentProj.features.push({name: f, done: false});
    
    markDirty(`Added feature: ${f}`);
    saveToFirebase();
}

    function toggleFeature(i) {
        if(!isAdmin) return;
        currentProj.features[i].done = !currentProj.features[i].done;
        markDirty(`Checked off ${currentProj.features[i].name}`);
        saveToFirebase();
    }

    function renderSpeedups() {
    const list = document.getElementById('speedupList');
    const items = currentProj.speedups || [];
    
    list.innerHTML = items.map((s, i) => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.3); padding:10px 16px; border-radius:12px; margin-bottom:6px; border: ${s.active && isAdmin ? '1px solid #4CAF50' : '1px solid transparent'};">
            <div style="display:flex; flex-direction:column;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:0.9rem; font-weight:500;">${s.name} (+$${s.price})</span>
                    ${isAdmin && s.active ? `
                        <div class="badge-requested">
                            <span class="material-symbols-outlined" style="font-size:14px;">check_circle</span>
                            CLIENT REQUESTED
                        </div>
                    ` : ''}
                </div>
${s.days ? `<span style="font-size:0.7rem; opacity:0.7;">${s.days > 0 ? '+' : ''}${s.days} days to delivery</span>` : ''}
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                ${isAdmin ? `
                    <button onclick="removeAddon(${i})" style="background:none; border:none; color:red; cursor:pointer;" class="no-print">
                        <span class="material-symbols-outlined" style="font-size:18px;">delete</span>
                    </button>
                ` : ''}
                <input type="checkbox" ${s.active ? 'checked' : ''} ${isAdmin ? 'disabled' : ''} onchange="toggleSpeed(${i})" style="width:20px; height:20px; cursor:${isAdmin ? 'default' : 'pointer'};">
            </div>
        </div>
    `).join('');
}

    async function addAddonPrompt() {
    const name = await showModal("New Add-on", "What is the name of this service?", true);
    if (!name) return;
    const price = parseFloat(await showModal("Price", "Enter price in USD:", true, "50")) || 0;
    const days = parseInt(await showModal("Timeline", "Extra days added?", true, "0")) || 0;
    
    if (!currentProj.speedups) currentProj.speedups = [];
    currentProj.speedups.push({ name, price, days, active: false });
    markDirty(`Dev added option: ${name}`);
    saveToFirebase();
}

    function removeAddon(i) {
        if (!confirm("Remove?")) return;
        currentProj.speedups.splice(i, 1);
        saveToFirebase();
    }

    function toggleSpeed(i) {
        const item = currentProj.speedups[i];
        item.active = !item.active;
        markDirty(`Client ${item.active ? 'requested' : 'removed'} ${item.name}`);
        let d = new Date(currentProj.end);
            
            if (item.days < 0){
                d.setDate(d.getDate() - (item.active ? Math.abs(item.days) : -Math.abs(item.days)));
            }
            else{
                d.setDate(d.getDate() + (item.active ? item.days : -item.days));
            }

            currentProj.end = d.toISOString().split('T')[0];
        saveToFirebase();
    }

    function postComment() {
        const el = document.getElementById('newComment');
        if(!el.value) return;
        if(!currentProj.comments) currentProj.comments = [];
        currentProj.comments.unshift(`<b>${isAdmin ? 'Developer' : 'Client'}:</b> ${el.value}`);
        el.value = "";
        saveToFirebase();
    }

    function renderFeatures() {
        const list = document.getElementById('featureList');
        const feats = currentProj.features || [];
        list.innerHTML = feats.length === 0 ? `<p style="opacity:0.4; font-size:0.8rem;">No features.</p>` : 
            feats.map((f, i) => `
                <div class="feature-item ${f.done ? 'done' : ''}" onclick="toggleFeature(${i})" style="cursor:${isAdmin?'pointer':'default'}">
                    <span class="material-symbols-outlined" style="color:${f.done ? 'var(--primary)' : '#ccc'}">
                        ${f.done ? 'check_circle' : 'radio_button_unchecked'}
                    </span>
                    <span>${f.name}</span>
                </div>
            `).join('');
    }

    function renderHistory() {
        document.getElementById('historyList').innerHTML = (currentProj.history || []).map(h => 
            `<div class="history-entry"><b>${h.t}</b><br><span style="opacity:0.5">${h.d}</span></div>`
        ).join('');
    }

    function renderComments() {
        document.getElementById('commentsList').innerHTML = (currentProj.comments || []).map(c => 
            `<div style="background:rgba(255,255,255,0.7); padding:12px; border-radius:12px; margin-bottom:8px; font-size:0.9rem;">${c}</div>`
        ).join('');
    }

    function updateProgress() {
        const start = new Date(currentProj.start).getTime();
        const end = new Date(currentProj.end).getTime();
        const now = Date.now();
        let pct = ((now - start) / (end - start)) * 100;
        document.getElementById('t_progress').style.width = Math.min(100, Math.max(0, pct)) + "%";
    }

    function getHue(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        return Math.abs(hash % 360);
    }

    function updateTheme(str) { document.documentElement.style.setProperty('--hue', getHue(str)); }

    function markDirty(msg) {
        if(!currentProj.history) currentProj.history = [];
        currentProj.history.unshift({t: msg, d: new Date().toLocaleString()});
    }

    function copyLink() {
        const el = document.getElementById("clientLink");
        el.select(); document.execCommand("copy"); alert("Link copied!");
    }

    async function deleteProject(id) {
    const confirmed = await showModal("Delete Project", "Are you sure? This cannot be undone.");
    if(confirmed) db.ref("projects/" + id).remove();
}

    async function showModal(title, body, hasInput = false, defaultValue = "") {
    return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const inputContainer = document.getElementById('modalInputContainer');
        const input = document.getElementById('modalInput');
        
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerText = body;
        modal.classList.remove('hidden');
        
        if (hasInput) {
            inputContainer.classList.remove('hidden');
            input.value = defaultValue;
            input.focus();
        } else {
            inputContainer.classList.add('hidden');
        }

        document.getElementById('modalConfirm').onclick = () => {
            modal.classList.add('hidden');
            resolve(hasInput ? input.value : true);
        };
        document.getElementById('modalCancel').onclick = () => {
            modal.classList.add('hidden');
            resolve(null);
        };
    });
}

function renderAIAnalysis() {
    const container = document.getElementById('ai_analysis_box');
    if (!container || !currentProj) return;

    const steps = [
        { msg: "Analyzing project scope", delay: 900 },
        { msg: "Evaluating feature density", delay: 1100 },
        { msg: "Benchmarking industry rates", delay: 1000 },
        { msg: "Calculating deal sentiment", delay: 700 }
    ];

    let currentStep = 0;

    function runLoader() {
        if (currentStep < steps.length) {
            container.innerHTML = `
                <div style="background: var(--surface-variant); padding: 20px; border-radius: 28px; border: 1px solid var(--outline-variant);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div class="m3-spinner"></div>
                        <div style="font-weight: 500; font-size: 0.9rem; color: var(--on-surface); opacity: 0.8;">
                            ${steps[currentStep].msg}...
                        </div>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                        <div style="width: ${(currentStep + 1) * 25}%; height: 100%; background: var(--primary); transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);"></div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                currentStep++;
                runLoader();
            }, steps[currentStep].delay); 
        } else {
            finalizeAnalysis(container);
        }
    }
    runLoader();
}

/**
 * 2. THE RESULT: Shows the high-value card and the Pay button
 */

 function finalizeAnalysis(container) {
    if (!currentProj) return;

    // 1. GET STUDIO CONTEXT (From your saved Firebase settings)
    const exp = document.getElementById('admin_exp')?.value || 'mid';
    const size = document.getElementById('admin_size')?.value || 'solo';
    
    // 2. CALCULATE BASELINE (What you SHOULD be charging)
    let baseline = 250; // Base price per feature
    if (exp === 'senior') baseline += 200;
    if (exp === 'junior') baseline -= 100;
    if (size === 'agency') baseline += 150;

    // 3. PROJECT STATS
    const total = currentProj.totalDisplayPrice || currentProj.price || 0;
    const featureCount = (currentProj.features ? currentProj.features.length : 0) || 1;
    const actualRatio = total / featureCount;

    // 4. THE 4-STAGE REACTION HEURISTICS
    let result;

    if (actualRatio < baseline * 0.75) {
        // Way below baseline
        result = {
            label: "HIGH VALUE",
            desc: "The scope exceeds the cost. This is a highly competitive rate for your profile.",
            color: "#386a3e",
            bgColor: "#e8f2e9",
            icon: "auto_awesome",
            conf: 94 + (Math.random() * 4)
        };
    } else if (actualRatio <= baseline * 1.25) {
        // Within 25% of baseline
        result = {
            label: "MARKET AVERAGE",
            desc: "This quote aligns perfectly with industry standards for your expertise level.",
            color: "#1565c0",
            bgColor: "#e3f2fd",
            icon: "insights",
            conf: 88 + (Math.random() * 5)
        };
    } else if (actualRatio <= baseline * 1.8) {
        // Up to 80% over baseline
        result = {
            label: "PREMIUM QUOTE",
            desc: "Reflects high-end technical complexity and specialized Unity development.",
            color: "#6200ee",
            bgColor: "#f3e5f5",
            icon: "verified",
            conf: 91 + (Math.random() * 3)
        };
    } else {
        // Over 80% higher than baseline
        result = {
            label: "ELITE / CUSTOM",
            desc: "Pricing indicates a high-priority, white-glove service or extreme complexity.",
            color: "#b71c1c",
            bgColor: "#fff1f1",
            icon: "priority_high",
            conf: 85 + (Math.random() * 5)
        };
    }

    renderAnalysisUI(container, result);
}

function renderAnalysisUI(container, result) {
    container.innerHTML = `
        <div class="fade-in ai-analysis-card" style="
            background:${result.bgColor}; 
            border:1px solid ${result.color}25; 
            padding:20px; 
            border-radius:28px; 
            display: flex; 
            flex-direction: column; 
            gap: 4px;
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            margin: 0 auto;
        ">
            
            <div style="display:flex; align-items:center; gap:8px; color:${result.color};">
                <span class="material-symbols-outlined" style="font-size: 18px;">${result.icon}</span>
                <strong style="font-size: 0.65rem; letter-spacing: 0.8px; text-transform: uppercase; font-weight: 800;">AI Deal Analysis</strong>
            </div>
            
            <div class="ai-verdict-title" style="font-weight: 900; font-size: 1.35rem; color: ${result.color}; line-height: 1.2; margin-top: 2px;">
                ${result.label}
            </div>
            
            <div style="font-size: 0.85rem; color: #444; line-height: 1.5; margin-bottom: 12px; font-weight: 500;">
                ${result.desc}
            </div>

            <div style="padding-top: 12px; border-top: 1px solid ${result.color}15;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 0.6rem; font-weight: 800; color: ${result.color}; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px;">Engine Confidence</span>
                    <span id="ai_conf_num" style="font-size: 0.75rem; font-weight: 900; color: ${result.color}; font-variant-numeric: tabular-nums;">0.0%</span>
                </div>
                <div style="height: 6px; width: 100%; background: rgba(0,0,0,0.06); border-radius: 10px; overflow: hidden;">
                    <div id="ai_confidence_fill" style="height: 100%; width: 0%; background: ${result.color}; border-radius: 10px; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);"></div>
                </div>
            </div>

            <div style="margin-top: 16px; width: 100%;">
                <button onclick="initiatePayment()" class="m3-pay-btn" style="background: ${result.color}; width: 100%; border-radius: 100px;">
                    <span class="material-symbols-outlined" style="font-size: 20px;">payments</span>
                    Pay $${currentProj.totalDisplayPrice} via PayPal
                </button>
            </div>
        </div>
    `;

    // Re-trigger animations (as defined in previous step)
    setTimeout(() => {
        const fillBar = document.getElementById('ai_confidence_fill');
        const numLabel = document.getElementById('ai_conf_num');
        if (fillBar && numLabel) {
            fillBar.style.width = result.conf + "%";
            animateNumber(numLabel, result.conf);
        }
    }, 100);
}

function animateNumber(el, target) {
    let start = 0;
    const duration = 1500;
    const startTime = performance.now();

    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(2, -10 * progress);
        el.innerText = (target * eased).toFixed(1) + "%";
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}

/**
 * 3. THE ACTION: Opens PayPal.me
 */
function initiatePayment() {
    const paypalUsername = "pranavGowardun"; // <-- UPDATE THIS
    const total = currentProj.totalDisplayPrice || currentProj.price;
    const url = `https://www.paypal.com/paypalme/${paypalUsername}/${total}`;
    
    window.open(url, '_blank');
}

function calculateProjectHealth() {
    if (!currentProj) return null;

    const today = new Date();
    const end = new Date(currentProj.end);
    const start = new Date(currentProj.originalEnd || currentProj.end); // Use original start if stored
    
    // 1. Time Pressure (0 to 100)
    const totalDuration = Math.abs(end - start) || 1;
    const timeElapsed = Math.abs(today - start);
    const timeRatio = Math.min(timeElapsed / totalDuration, 1);

    // 2. Scope Density
    const featureCount = (currentProj.features || []).length;
    const density = featureCount / (totalDuration / (1000 * 60 * 60 * 24));

    // 3. Final Calculation
    let health = 100;
    if (timeRatio > 0.8) health -= 20; // Last 20% of time is high pressure
    if (density > 0.5) health -= 15;   // More than 1 feature every 2 days is heavy

    // Determine Status
    if (health > 80) return { score: health, label: "Healthy", color: "#386a3e", icon: "check_circle" };
    if (health > 50) return { score: health, label: "At Risk", color: "#f9a825", icon: "warning" };
    return { score: health, label: "Critical", color: "#b71c1c", icon: "emergency" };
}

function renderHealthCard() {
    const container = document.getElementById('ai_health_box');
    if (!container || !currentProj) return;

    // 1. DATA EXTRACTION
    const today = new Date();
    const end = new Date(currentProj.end);
    const start = new Date(currentProj.originalEnd || currentProj.end);
    
    const totalDurationMs = Math.abs(end - start) || 1;
    const timeRemainingMs = end - today;
    const daysRemaining = Math.ceil(timeRemainingMs / (1000 * 60 * 60 * 24));
    
    const tasks = currentProj.features || [];
    const totalTasks = tasks.length;
    // Flexible check for different naming conventions
    const completedTasks = tasks.filter(t => t.checked || t.completed || t.done).length;
    const remainingTasks = totalTasks - completedTasks;
    const completionRatio = totalTasks > 0 ? completedTasks / totalTasks : 0;
    const timeExhaustionRatio = Math.min(Math.abs(today - start) / totalDurationMs, 1);

    // 2. REBALANCED VELOCITY LOGIC
    // Calculate how many days you have available for each task left
    const daysPerTask = remainingTasks > 0 ? daysRemaining / remainingTasks : daysRemaining;
    
    let score = 100;

    // Penalty A: Velocity Check (Fairer for long deadlines)
    // Only penalize if you have less than 1.5 days per task remaining
    if (remainingTasks > 0 && daysPerTask < 1.5) {
        const urgencyPenalty = (1.5 - daysPerTask) * 20; 
        score -= urgencyPenalty;
    }

    // Penalty B: The Lag Check (Only kicks in after 60% of time is used)
    if (timeExhaustionRatio > 0.6) {
        const lag = timeExhaustionRatio - completionRatio;
        if (lag > 0.1) {
            score -= (lag * 30);
        }
    }

    // Penalty C: Final Countdown (Last 3 days)
    if (daysRemaining <= 3 && daysRemaining > 0 && completionRatio < 0.9) {
        score -= 15;
    }

    // Overdue Logic
    if (daysRemaining < 0 && completionRatio < 1) {
        score = 10;
    }

    score = Math.max(5, Math.min(100, Math.round(score)));

    // 3. THEME SELECTION
    let health = { 
        label: "Stable Pace", 
        color: "#386a3e", 
        icon: "verified", 
        bg: "rgba(56, 106, 62, 0.06)",
        tip: "Project is well-buffered. Timeline vs. task density is optimal."
    };

    if (score < 80) {
        health = { 
            label: "High Pressure", 
            color: "#f9a825", 
            icon: "bolt", 
            bg: "rgba(249, 168, 37, 0.06)",
            tip: "Velocity is tightening. Completion rate needs to increase to meet deadline."
        };
    }

    if (score < 45) {
        health = { 
            label: "Critical Delay", 
            color: "#b71c1c", 
            icon: "speed", 
            bg: "rgba(183, 28, 28, 0.06)",
            tip: "Workload exceeds remaining time. Scope reduction or extension required."
        };
    }

    // 4. UI RENDER
    container.innerHTML = `
        <div class="fade-in" style="background: ${health.bg}; padding: 22px; border-radius: 28px; border: 1px solid ${health.color}20; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="display: flex; align-items: center; gap: 6px; color: ${health.color};">
                        <span class="material-symbols-outlined" style="font-size: 18px;">${health.icon}</span>
                        <strong style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px;">AI Project Health</strong>
                    </div>
                    <div style="font-size: 1.4rem; font-weight: 900; margin-top: 4px; color: #1a1c1e;">${health.label}</div>
                </div>
                <div style="text-align: right;">
                    <div id="health_score_num" style="font-size: 1.6rem; font-weight: 900; color: ${health.color}; font-variant-numeric: tabular-nums;">0%</div>
                    <div style="font-size: 0.6rem; opacity: 0.5; font-weight: 800; text-transform: uppercase;">Stability Index</div>
                </div>
            </div>

            <div style="height: 10px; width: 100%; background: rgba(0,0,0,0.05); border-radius: 10px; margin-top: 14px; overflow: hidden;">
                <div id="health_bar_fill" style="height: 100%; width: 0%; background: ${health.color}; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 10px;"></div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 16px; align-items: flex-end;">
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <span style="font-size: 0.85rem; font-weight: 800; color: #1a1c1e;">
                        ${daysRemaining > 0 ? daysRemaining + ' Days Remaining' : 'Deadline Passed'}
                    </span>
                    <span style="font-size: 0.7rem; opacity: 0.7; color: #444;">
                        ${remainingTasks} of ${totalTasks} features to build
                    </span>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.75rem; font-weight: 700; color: ${health.color}; background: #fff; padding: 4px 10px; border-radius: 12px; border: 1px solid ${health.color}30;">
                        ${Math.round(completionRatio * 100)}% Complete
                    </div>
                </div>
            </div>

            <p style="font-size: 0.75rem; margin-top: 12px; opacity: 0.8; line-height: 1.4; color: #444; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 12px;">
                <strong>AI Insight:</strong> ${health.tip}
            </p>
        </div>
    `;

    // 5. ANIMATION TRIGGERS
    setTimeout(() => {
        const fillBar = document.getElementById('health_bar_fill');
        const scoreLabel = document.getElementById('health_score_num');
        
        if (fillBar) fillBar.style.width = score + "%";
        if (scoreLabel) {
            let start = 0;
            const duration = 1500;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(2, -10 * progress);
                const currentVal = Math.floor(score * eased);
                
                scoreLabel.innerText = currentVal + "%";
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }
    }, 450);
}

function animateHealthNumber(el, target) {
    let start = 0;
    const duration = 1500; // 1.5 seconds to match the CSS transition
    const startTime = performance.now();

    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth finish
        const eased = 1 - Math.pow(2, -10 * progress);
        
        const currentVal = Math.floor(target * eased);
        el.innerText = currentVal + "%";

        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    requestAnimationFrame(update);
}

function getHealthTip(status) {
    if (status === "Healthy") return "Project is on track. Deliverables are balanced with the current timeline.";
    if (status === "At Risk") return "Timeline is tightening. Consider simplifying scope or enabling speed-up add-ons.";
    return "High risk of delay. Immediate scope adjustment or deadline extension recommended.";
}

</script>

<div id="customModal" class="modal-overlay hidden">
    <div class="modal-card">
        <h3 id="modalTitle">Title</h3>
        <p id="modalBody" style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 20px;"></p>
        <div id="modalInputContainer" class="hidden">
            <input type="text" id="modalInput" style="margin-bottom: 15px;">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
            <button class="btn btn-outline" id="modalCancel">Cancel</button>
            <button class="btn btn-filled" id="modalConfirm">Confirm</button>
        </div>
    </div>
</div>
</body>
</html>
